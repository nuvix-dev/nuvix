import { copy } from 'esbuild-plugin-copy'
import { defineConfig } from 'tsup'

function printStylizedNuvix() {
  const logo = `
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*+=========+@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@========================@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@+===============================@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@=====================================+@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@+==========================================+@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+==============================================+@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@+===================+*+===========================*=+=======++@@@
@@@@@@@@@@@@@+===============+@@@@@@@@@@@@@==========================@@@@@@+@@@@
@@@@@@@@@@@@+==============+@@@@@@@@@@@@@@@@@+===================@@@@@@@@+++@@@@
@@@@@@@@@@@+=============+@@@@@@@@@@@@@@@@@@@@@==============+@@@@@@@@@@++*@@@@@
@@@@@@@@@@@==============@@@@@@@@@@@@@@@@@@@@@@@+==========@@@@@@@@@@@@+++@@@@@@
@@@@@@@@@@=============@@@@@@@@@@@@@=+@@@@@@@@@@@@=======@@@@@@@@@@@@*+++@@@@@@@
@@@@@@@@@============*@@@@@@@@@@@@=====@@@@@@@@@@@@*===*@@@@@@@@@@@@+++*@@@@@@@@
@@@@@@@@@===========@@@@@@@@@@@@@=======+@@@@@@@@@@===@@@@@@@@@@@@+++++@@@@@@@@@
@@@@@@@@@==========@@@@@@@@@@@@@@@+======+@@@@@@@====@@@@@@@@@@@@++++++@@@@@@@@@
@@@@@@@@@========+@@@@@@@@@@@@@@@@@@=======@@@@@===+@@@@@@@@@@@@+++++++@@@@@@@@@
@@@@@@@@@=======@@@@@@@@@@@@@@@@@@@@@=======@@-===@@@@@@@@@@@@+++++++++@@@@@@@@@
@@@@@@@@@======@@@@@@@@@@@@@@@@@@@@@@@+======+==+@@@@@@@@@@@@++++++++++@@@@@@@@@
@@@@@@@@@====+@@@@@@@@@@@@+*@@@@@@@@@@@*=======+@@@@@@@@@@@@+++++++++++@@@@@@@@@
@@@@@@@@+===@@@@@@@@@@@@@+++*@@@@@@@@@@@@=====@@@@@@@@@@@@%++++++++++++@@@@@@@@@
@@@@@@@+==+@@@@@@@@@@@@+++++++@@@@@@@@@@@@@=@@@@@@@@@@@@@+++++++++++++@@@@@@@@@@
@@@@@@+==@@@@@@@@@@@@+++++++++++@@@@@@@@@@@@@@@@@@@@@@@++++++++++++++@@@@@@@@@@@
@@@@@+==@@@@@@@@@@*++++++++++++++@@@@@@@@@@@@@@@@@@@@@+++++++++++++++@@@@@@@@@@@
@@@@+==@@@@@@@@%+++++++++++++++++++@@@@@@@@@@@@@@@@@*++++++++++++++*@@@@@@@@@@@@
@@@@=@@@@@@*+++++++++++++++++++++++++@@@@@@@@@@@@@+++++++++++++++++@@@@@@@@@@@@@
@@@++++++++++*@++++++++++++++++++++++++++++**++++++++++++++++++++%@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@++++++++++++++++++++++++++++++++++++++++++++++++@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@#++++++++++++++++++++++++++++++++++++++++++*@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@++++++++++++++++++++++++++++++++++++++@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@++++++++++++++++++++++++++++++++@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@++++++++++++++++++++++++@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*+++++++++#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
`
  console.log(`\x1b[38;2;131;189;194m${logo}\x1b[0m`)
}

export default defineConfig(options => {
  const isDev = !!options.watch
  if (!isDev) {
    printStylizedNuvix()
  }

  return {
    entry: ['src/main.ts'],
    format: ['esm'],
    dts: false,
    sourcemap: isDev,
    clean: !isDev,
    outDir: isDev ? 'dist' : '../../dist/server/build',
    noExternal: ['@nuvix/core', '@nuvix/utils'],
    splitting: false,
    minify: !isDev,
    target: 'es2024',
    skipNodeModulesBundle: true,
    bundle: true,
    shims: false,
    tsconfig: './tsconfig.app.json',
    onSuccess: !isDev ? undefined : 'sleep 1 && bun --watch dist/main.js',
    banner({ format }) {
      const envPaths: string[] = isDev
        ? ['../../.env', '../../.env.local']
        : ['.env', '.env.server']
      return {
        js:
          format === 'esm'
            ? `import { config as __nxconfig } from 'dotenv';
import {default as __nxpath}  from 'path';
__nxconfig({
  path: [${envPaths.map(p => `__nxpath.resolve(process.cwd(), '${p}')`).join(',\n\t')}]
});`
            : `const __nxpath = require('path');
require('dotenv').config({
    path: [${envPaths.map(p => `__nxpath.resolve(process.cwd(), '${p}')`).join(',\n\t')}]
});`,
      }
    },
    esbuildPlugins: isDev
      ? []
      : [
          copy({
            assets: [
              {
                from: ['../../assets/**/*'],
                to: ['../assets'],
              },
              {
                from: ['../../docs/references/**/*'],
                to: ['../docs/references'],
              },
              {
                from: ['../../public/**/*'],
                to: ['../public'],
              },
              {
                from: ['../../LICENSE', '../../.env.example'],
                to: ['../'],
              },
              {
                from: ['../../README.md'],
                to: ['../README.md'],
              },
            ],
          }),
        ],
  }
})
